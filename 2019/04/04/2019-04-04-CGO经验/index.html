<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CGO 使用经验 · MEX7</title><meta name="description" content="CGO 使用经验 - mex7"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://mex7.github.io/atom.xml" title="MEX7"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="MEX7" type="application/atom+xml">
</head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">MEX7</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>INDEX</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>ARCHIVES</p></a><ul class="shortcut-icons"><a href="https://github.com/AngryPowman" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">CGO 使用经验</h1><div class="post-info">Apr 4, 2019</div><div class="post-content"><h2 id="常见写法转换规范"><a href="#常见写法转换规范" class="headerlink" title="常见写法转换规范"></a>常见写法转换规范</h2><h3 id="char-data"><a href="#char-data" class="headerlink" title="char *data"></a>char *data</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var data []byte</span><br><span class="line"></span><br><span class="line">cData :&#x3D; C.CString(string(data[:]))</span><br><span class="line">defer C.free(unsafe.Pointer(cData))</span><br></pre></td></tr></table></figure>

<h3 id="const-char-data"><a href="#const-char-data" class="headerlink" title="const char* data"></a>const char* data</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var data []byte</span><br><span class="line"></span><br><span class="line">cData :&#x3D; C.CString(string(data[:]))</span><br><span class="line">defer C.free(unsafe.Pointer(cData))</span><br></pre></td></tr></table></figure>

<h3 id="long-long-data"><a href="#long-long-data" class="headerlink" title="long long data"></a>long long data</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C.longlong(h.data)</span><br></pre></td></tr></table></figure>

<h3 id="const-char-const-data"><a href="#const-char-const-data" class="headerlink" title="const char* const data"></a>const char* const data</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cUrl :&#x3D; C.CString(h.url)</span><br><span class="line">defer C.free(unsafe.Pointer(cUrl))</span><br></pre></td></tr></table></figure>

<h3 id="使用-h文件中的变量"><a href="#使用-h文件中的变量" class="headerlink" title="使用.h文件中的变量"></a>使用.h文件中的变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output :&#x3D; &amp;C.dy_fcover_out&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据回调"><a href="#数据回调" class="headerlink" title="数据回调"></a>数据回调</h3><p>同目录下新建bridge.go文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package lib</span><br><span class="line"></span><br><span class="line">&#x2F;*</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; The gateway function</span><br><span class="line">void callOnMeGo_cgo(int rid,int status,const char *info)</span><br><span class="line">&#123;</span><br><span class="line">	void callOnMeGo(int,int,const char*);</span><br><span class="line">	return callOnMeGo(rid,status,info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*&#x2F;</span><br><span class="line">import &quot;C&quot;</span><br></pre></td></tr></table></figure>

<p>逻辑代码文件里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">var Task struct &#123;</span><br><span class="line">	fn func(int64, int32, string)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;export callOnMeGo</span><br><span class="line">func callOnMeGo(jid int64, status int32, info *C.char) &#123;</span><br><span class="line">	Task.fn(jid, status, C.GoString(info))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Register ...</span><br><span class="line">func (h *GcrWorker) Start(callback func(int64, int32, string)) int &#123;</span><br><span class="line">	Task.fn &#x3D; callback</span><br><span class="line">	return int(C.start_recognizer_task(h.handler, (C.GCRCallback)(unsafe.Pointer(C.callOnMeGo_cgo))))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>外部调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">handler.Start(func(jid int64, status int32, info string) &#123;</span><br><span class="line">	l.callback(jid, status, info, isPush)</span><br><span class="line">	return</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="环境变量导入"><a href="#环境变量导入" class="headerlink" title="环境变量导入"></a>环境变量导入</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export LD_LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;dy-ID-recognition&#x2F;id_detect&#x2F;lib:$LD_LIBRARY_PATH</span><br><span class="line">export LIBRARY_PATH&#x3D;&#x2F;opt&#x2F;dy-ID-recognition&#x2F;id_detect&#x2F;lib:$LIBRARY_PATH</span><br></pre></td></tr></table></figure>


<h2 id="某些时候可能需要的环境安装"><a href="#某些时候可能需要的环境安装" class="headerlink" title="某些时候可能需要的环境安装"></a>某些时候可能需要的环境安装</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apt-get install autoconf autogen</span><br><span class="line">apt-get install libtool</span><br><span class="line">apt-get install libopenblas-dev</span><br><span class="line">apt-get install libhdf5-10</span><br><span class="line">apt-get install libhdf5-serial-dev</span><br><span class="line">apt-get install libhdf5-dev</span><br><span class="line">apt-get install libhdf5-cpp-11</span><br><span class="line">apt-get install libleveldb-dev</span><br><span class="line">apt-get install --no-install-recommends libboost-all-dev</span><br><span class="line">apt-get install libgflags-dev libgoogle-glog-dev liblmdb-dev</span><br></pre></td></tr></table></figure>


<h3 id="probuf-安装"><a href="#probuf-安装" class="headerlink" title="probuf 安装"></a>probuf 安装</h3><p>选择合适的版本下载，例如：</p>
<blockquote>
<p><a href="https://github.com/google/protobuf/releases/download/v3.6.0/protobuf-all-3.6.0.tar.gz" target="_blank" rel="noopener">https://github.com/google/protobuf/releases/download/v3.6.0/protobuf-all-3.6.0.tar.gz</a><br>wget <a href="https://github.com/google/protobuf/archive/v3.3.0.zip" target="_blank" rel="noopener">https://github.com/google/protobuf/archive/v3.3.0.zip</a></p>
</blockquote>
<h3 id="opencv-安装"><a href="#opencv-安装" class="headerlink" title="opencv 安装"></a>opencv 安装</h3><p>选择合适的版本下载，例如：</p>
<blockquote>
<p>wget <a href="https://github.com/opencv/opencv/archive/3.4.0.tar.gz" target="_blank" rel="noopener">https://github.com/opencv/opencv/archive/3.4.0.tar.gz</a></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf opencv-3.4.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> opencv-3.4.0</span><br><span class="line">mkdir build &amp;&amp; <span class="built_in">cd</span> build</span><br><span class="line">cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_DOCS=off -DBUILD_TESTS=off -DBUILD_JAVA=off -DWITH_MATLAB=off -DBUILD_opencv_python2=off -DBUILD_opencv_python3=off -DWITH_CUDA=off -DWITH_OPENCL=off -DWITH_FFMPEG=off -DWITH_IPP=off -DWITH_JPEG=on -DWITH_PNG=on -DWITH_TBB=off -DWITH_TIFF=off -DWITH_WEBP=off</span><br><span class="line">make -j8</span><br><span class="line">make install</span><br><span class="line"><span class="built_in">cd</span> ../../</span><br></pre></td></tr></table></figure>

<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><h3 id="no-configuration-information-is-in-third-party-googletest"><a href="#no-configuration-information-is-in-third-party-googletest" class="headerlink" title="no configuration information is in third_party/googletest"></a>no configuration information is in third_party/googletest</h3><p>需要下载googletest<br>下载地址：<a href="https://github.com/google/googletest/releases" target="_blank" rel="noopener">https://github.com/google/googletest/releases</a><br>解压后放在./protobuf-3.6.1/third_party/googletest<br>然后执行./autogen.sh</p>
<h3 id="Building-Caffe-on-Ubuntu-make-can’t-find-Boost’s-include-files"><a href="#Building-Caffe-on-Ubuntu-make-can’t-find-Boost’s-include-files" class="headerlink" title="Building Caffe on Ubuntu: make can’t find Boost’s include files"></a>Building Caffe on Ubuntu: make can’t find Boost’s include files</h3><p><a href="https://stackoverflow.com/questions/28867791/building-caffe-on-ubuntu-make-cant-find-boosts-include-files" target="_blank" rel="noopener">https://stackoverflow.com/questions/28867791/building-caffe-on-ubuntu-make-cant-find-boosts-include-files</a></p>
<h3 id="glog-logging-h-No-such-file-or-directory"><a href="#glog-logging-h-No-such-file-or-directory" class="headerlink" title="glog/logging.h: No such file or directory"></a>glog/logging.h: No such file or directory</h3><p><a href="https://github.com/BVLC/caffe/wiki/Commonly-encountered-build-issues" target="_blank" rel="noopener">https://github.com/BVLC/caffe/wiki/Commonly-encountered-build-issues</a></p>
<h3 id="cublas-v2-h-No-such-file-or-directory"><a href="#cublas-v2-h-No-such-file-or-directory" class="headerlink" title="cublas_v2.h: No such file or directory"></a>cublas_v2.h: No such file or directory</h3><p><a href="https://blog.csdn.net/xcls2010/article/details/80422538" target="_blank" rel="noopener">https://blog.csdn.net/xcls2010/article/details/80422538</a></p>
<h3 id="can’t-find-hdf5-h-when-build-caffe"><a href="#can’t-find-hdf5-h-when-build-caffe" class="headerlink" title="can’t find hdf5.h when build caffe"></a>can’t find hdf5.h when build caffe</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find /usr -iname <span class="string">"*hdf5.h*"</span></span><br><span class="line">/usr/include/hdf5/serial/hdf5.h</span><br><span class="line"><span class="built_in">export</span> CPATH=<span class="string">"/usr/include/hdf5/serial/"</span></span><br></pre></td></tr></table></figure>

<h3 id="插件缺失"><a href="#插件缺失" class="headerlink" title="插件缺失"></a>插件缺失</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@bs1-pubrelease-109 protobuf]# .&#x2F;autogen.sh </span><br><span class="line">+ mkdir -p third_party&#x2F;googletest&#x2F;m4</span><br><span class="line">+ autoreconf -f -i -Wall,no-obsolete</span><br><span class="line">configure.ac:104: error: possibly undefined macro: AC_PROG_LIBTOOL</span><br><span class="line">      If this token and others are legitimate, please use m4_pattern_allow.</span><br><span class="line">      See the Autoconf documentation.</span><br><span class="line">autoreconf: &#x2F;usr&#x2F;bin&#x2F;autoconf failed with exit status: 1</span><br></pre></td></tr></table></figure>
<p>根据提示安装就可以了</p>
<h3 id="caffe-—找不到lhdf5-hl和lhdf5的错误"><a href="#caffe-—找不到lhdf5-hl和lhdf5的错误" class="headerlink" title="caffe —找不到lhdf5_hl和lhdf5的错误"></a>caffe —找不到lhdf5_hl和lhdf5的错误</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//重要的一项</span><br><span class="line">将<span class="comment"># Whatever else you find you need goes here.下面的</span></span><br><span class="line">INCLUDE_DIRS := $(PYTHON_INCLUDE) /usr/<span class="built_in">local</span>/include</span><br><span class="line">LIBRARY_DIRS := $(PYTHON_LIB) /usr/<span class="built_in">local</span>/lib /usr/lib</span><br><span class="line">修改为：</span><br><span class="line">INCLUDE_DIRS :=  $(PYTHON_INCLUDE) /usr/<span class="built_in">local</span>/include /usr/include/hdf5/serial</span><br><span class="line">LIBRARY_DIRS := $(PYTHON_LIB) /usr/<span class="built_in">local</span>/lib /usr/lib /usr/lib/x86_64-linux-gnu /usr/lib/x86_64-linux-gnu/hdf5/serial</span><br><span class="line">//这是因为ubuntu16.04的文件包含位置发生了变化，尤其是需要用到的hdf5的位置，所以需要更改这一路径</span><br><span class="line"> </span><br><span class="line"><span class="built_in">cd</span> /usr/lib/x86_64-linux-gnu</span><br><span class="line"> </span><br><span class="line">\\然后根据情况执行下面两句：</span><br><span class="line">sudo ln -s libhdf5_serial.so.10.1.0 libhdf5.so</span><br><span class="line">sudo ln -s libhdf5_serial_hl.so.10.0.2 libhdf5_hl.so</span><br></pre></td></tr></table></figure>

<h3 id="使用-C-变量可能出现"><a href="#使用-C-变量可能出现" class="headerlink" title="使用 C++ 变量可能出现"></a>使用 C++ 变量可能出现</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AR -o .build_release&#x2F;lib&#x2F;libcaffe.a</span><br><span class="line">LD -o .build_release&#x2F;lib&#x2F;libcaffe.so.1.0.0-rc3</span><br><span class="line">CXX tools&#x2F;caffe.cpp</span><br><span class="line">CXX&#x2F;LD -o .build_release&#x2F;tools&#x2F;caffe.bin</span><br><span class="line">.build_release&#x2F;lib&#x2F;libcaffe.so: undefined reference to &#96;cv::imread(cv::String const&amp;, int)&#39;</span><br><span class="line">.build_release&#x2F;lib&#x2F;libcaffe.so: undefined reference to &#96;cv::imencode(cv::String const&amp;, cv::_InputArray const&amp;, std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;&amp;, std::vector&lt;int, std::allocator&lt;int&gt; &gt; const&amp;)&#39;</span><br><span class="line">.build_release&#x2F;lib&#x2F;libcaffe.so: undefined reference to &#96;cv::imdecode(cv::_InputArray const&amp;, int)&#39;</span><br><span class="line">collect2: error: ld returned 1 exit status</span><br><span class="line">make: *** [.build_r</span><br></pre></td></tr></table></figure>

<h3 id="cannot-use-amp-ctx"><a href="#cannot-use-amp-ctx" class="headerlink" title="cannot use &amp;ctx"></a>cannot use &amp;ctx</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:&#x2F;home&#x2F;www&#x2F;server&#x2F;*gopath&#x2F;src&#x2F;*&#x2F;lib# go test</span><br><span class="line">.&#x2F;ids.go:48: cannot use &amp;ctx (type *unsafe.Pointer) as type *_Ctype_dy_handle_t in argument to func literal</span><br><span class="line">.&#x2F;ids.go:49: cannot use ret (type _Ctype_int) as type int in return argument</span><br><span class="line">.&#x2F;ids.go:58: cannot use ctx (type unsafe.Pointer) as type _Ctype_dy_handle_t in argument to func literal</span><br><span class="line">.&#x2F;ids.go:58: cannot use recType (type int) as type _Ctype_int in argument to func literal</span><br><span class="line">.&#x2F;ids.go:58: cannot use (func literal)(ctx, c, recType) (type _Ctype_int) as type int in return argument</span><br><span class="line">.&#x2F;ids.go:68: cannot use (func literal)(ctx, imgPath, &amp;resChar) (type _Ctype_int) as type int in assignment</span><br><span class="line">.&#x2F;ids.go:68: cannot use ctx (type unsafe.Pointer) as type _Ctype_dy_handle_t in argument to func literal</span><br><span class="line">.&#x2F;ids.go:76: cannot use ctx (type unsafe.Pointer) as type _Ctype_dy_handle_t in argument to func literal</span><br><span class="line">.&#x2F;ids.go:76: (func literal)(ctx) used as value</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/golang/go/issues/13467" target="_blank" rel="noopener">https://github.com/golang/go/issues/13467</a></p>
<h3 id="额"><a href="#额" class="headerlink" title="额.."></a>额..</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[ 90%] Building CXX object tools&#x2F;caffe&#x2F;CMakeFiles&#x2F;caffe2ncnn.dir&#x2F;caffe2ncnn.cpp.o</span><br><span class="line">In file included from &#x2F;usr&#x2F;local&#x2F;ncnn&#x2F;tools&#x2F;caffe&#x2F;caffe2ncnn.cpp:30:0:</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;ncnn&#x2F;build&#x2F;tools&#x2F;caffe&#x2F;caffe.pb.h:12:2: error: #error This file was generated by a newer version of protoc which is</span><br><span class="line"> #error This file was generated by a newer version of protoc which is</span><br><span class="line">  ^</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;ncnn&#x2F;build&#x2F;tools&#x2F;caffe&#x2F;caffe.pb.h:13:2: error: #error incompatible with your Protocol Buffer headers. Please update</span><br><span class="line"> #error incompatible with your Protocol Buffer headers.  Please update</span><br><span class="line">  ^</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;ncnn&#x2F;build&#x2F;tools&#x2F;caffe&#x2F;caffe.pb.h:14:2: error: #error your headers.</span><br><span class="line"> #error your headers.</span><br><span class="line">  ^</span><br><span class="line">&#x2F;usr&#x2F;local&#x2F;ncnn&#x2F;build&#x2F;tools&#x2F;caffe&#x2F;caffe.pb.h:23:35: fatal error: google&#x2F;protobuf&#x2F;arena.h: No such file or directory</span><br><span class="line"> #include &lt;google&#x2F;protobuf&#x2F;arena.h&gt;</span><br></pre></td></tr></table></figure>
<p>编译ncnn的时候<br>将ncnn/tools中的CMakeLists.txt中<br>前三行注释掉  </p>
<h3 id="代码问题"><a href="#代码问题" class="headerlink" title="代码问题"></a>代码问题</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">var</span> result <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">var</span> char *C.char</span><br><span class="line">	<span class="keyword">var</span> temp **C.char</span><br><span class="line">	char = C.CString(result)</span><br><span class="line">	temp = (**C.char)(&amp;char)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">int</span>(C.dy_idcard_recog_process(h.GetIDsHandler(recType), imgPath, temp)) != <span class="number">0</span> &#123;</span><br><span class="line">		err = errors.New(<span class="string">"dy_idcard_recog_process err"</span>)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(C.GoString(char))</span><br><span class="line">	C.free(temp)</span><br><span class="line">	C.free(char)</span><br><span class="line"></span><br><span class="line">*** Error in <span class="string">`./bin/wsd-ocr-srv-image-go': double free or corruption (out): 0x000000c42000e180 ***</span></span><br><span class="line"><span class="string">	s := make([]byte, 100)</span></span><br><span class="line"><span class="string">	//var temp **C.char</span></span><br><span class="line"><span class="string">	char := C.CString(string(s))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	fmt.Println("333", char)</span></span><br><span class="line"><span class="string">	defer C.free(unsafe.Pointer(char))</span></span><br><span class="line"><span class="string">	//temp = (**C.char)(&amp;char)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	//var resultX **C.char = C.genX()</span></span><br><span class="line"><span class="string">	//defer C.free(unsafe.Pointer(resultX))</span></span><br><span class="line"><span class="string">	//var resultXX *C.char = C.genXX(resultX)</span></span><br><span class="line"><span class="string">	//defer C.free(unsafe.Pointer(resultXX))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">	if int(C.dy_idcard_recog_process(h.GetIDsHandler(recType), imgPath, char)) != 0 &#123;</span></span><br><span class="line"><span class="string">		err = errors.New("dy_idcard_recog_process err")</span></span><br><span class="line"><span class="string">		return</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">	fmt.Println("444", char)</span></span><br></pre></td></tr></table></figure>
<p>变量释放出现问题，初始话的时候没有定义 byte 的 size 会导致释放失败，在多次调用之后出现。</p>
</div></article></div><div id="disqus_thread"></div></div><script>var disqus_shortname = 'mex7';
var disqus_identifier = '2019/04/04/2019-04-04-CGO经验/';
var disqus_title = 'CGO 使用经验';
var disqus_url = 'http://mex7.github.io/2019/04/04/2019-04-04-CGO经验/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mex7.disqus.com/count.js" async></script></main><footer class="footer-container"><div class="paginator"><a href="/2019/04/29/2019-04-25-GopherChina2019/" class="prev">PREV</a><a href="/2018/11/29/2018-11-29-Prometheus/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="http://mex7.github.io">mex7</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"MEX",'auto');ga('send','pageview');</script></body></html>