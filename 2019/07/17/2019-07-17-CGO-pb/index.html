<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 2019-07-17-CGO-pb · MEX7</title><meta name="description" content="2019-07-17-CGO-pb - mex7"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://mex7.github.io/atom.xml" title="MEX7"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="MEX7" type="application/atom+xml">
</head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">MEX7</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>INDEX</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>ARCHIVES</p></a><ul class="shortcut-icons"><a href="https://github.com/AngryPowman" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">2019-07-17-CGO-pb</h1><div class="post-info">Jul 17, 2019</div><div class="post-content"><h2 id="pb"><a href="#pb" class="headerlink" title="pb"></a>pb</h2><p>使用<code>char **protobuffer</code>获取pb编码的字节数据<code>int *protobuffer_len</code>表示字节长度</p>
<p>参考头文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SDK_API vod process(</span><br><span class="line">	dy_handle_t handle,</span><br><span class="line">	const char* data,</span><br><span class="line">	int length,</span><br><span class="line">	char **protobuffer,</span><br><span class="line">	int *protobuffer_len</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>获取返回数据方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var output *C.char</span><br><span class="line">resIntC :&#x3D; C.int(resInt)</span><br><span class="line"></span><br><span class="line">C.process(h.handler, dataC, dataSizeC, &amp;output, &amp;resIntC)</span><br></pre></td></tr></table></figure>

<p>按照上面这个方式能够获取到<code>output</code>回传的参数，问题在于如何将数据转换成<code>[]byte</code></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[]byte(C.GoString(output))</span><br></pre></td></tr></table></figure>
<p>问题：对<code>00 00 00</code> 产生截断，导致<code>proto.Unmarshal</code>报错</p>
<p><img src="https://i.loli.net/2019/07/17/5d2f3a5b22cab13798.png" alt="QQ截图20190717230529.png"></p>
<h3 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C.GoBytes(unsafe.Pointer(&amp;output), 11612)</span><br></pre></td></tr></table></figure>
<p>能保证前11612长度字节流数据正确，但是数据拷贝之后产生乱码，原因未知</p>
<p><img src="https://i.loli.net/2019/07/17/5d2f3a5b418d965348.png" alt="QQ截图20190717230740.png"></p>
<h3 id="0x3-正解"><a href="#0x3-正解" class="headerlink" title="0x3 正解"></a>0x3 正解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(*[]byte)(unsafe.Pointer(&amp;output))[0:11612]</span><br></pre></td></tr></table></figure>
<p>正确写法，直接使用内存数据，但如果不限制长度会到内存存储的连续数据片段</p>
<p><img src="https://i.loli.net/2019/07/18/5d2fd8329787929749.png" alt="2.png"></p>
<h2 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h2><p><a href="https://stackoverflow.com/questions/35673161/convert-go-byte-to-a-c-char" target="_blank" rel="noopener">https://stackoverflow.com/questions/35673161/convert-go-byte-to-a-c-char</a></p>
<p><a href="https://stackoverflow.com/questions/27532523/how-to-convert-1024c-char-to-1024byte" target="_blank" rel="noopener">https://stackoverflow.com/questions/27532523/how-to-convert-1024c-char-to-1024byte</a></p>
</div></article></div><div id="disqus_thread"></div></div><script>var disqus_shortname = 'mex7';
var disqus_identifier = '2019/07/17/2019-07-17-CGO-pb/';
var disqus_title = '2019-07-17-CGO-pb';
var disqus_url = 'http://mex7.github.io/2019/07/17/2019-07-17-CGO-pb/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mex7.disqus.com/count.js" async></script></main><footer class="footer-container"><div class="paginator"><a href="/2020/05/23/git/" class="prev">PREV</a><a href="/2019/06/13/2019-06-13-%E5%BC%B9%E5%B9%95%E5%8A%A0%E5%AF%86%E6%9C%8D%E5%8A%A1/" class="next">NEXT</a></div><div class="copyright"><p>© 2014 - 2021 <a href="http://mex7.github.io">mex7</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"MEX",'auto');ga('send','pageview');</script></body></html>